name: CI

on:
  push:
    branches: [ main, develop, 'cursor/**' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  # Fast matrix job - test each package in parallel
  test-matrix:
    name: Test ${{ matrix.package }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    strategy:
      fail-fast: false # Continue testing other packages even if one fails
      matrix:
        package:
          - github.com/fluxorio/fluxor/pkg/core
          - github.com/fluxorio/fluxor/pkg/core/concurrency
          - github.com/fluxorio/fluxor/pkg/config
          - github.com/fluxorio/fluxor/pkg/db
          - github.com/fluxorio/fluxor/pkg/fluxor
          - github.com/fluxorio/fluxor/pkg/fx
          - github.com/fluxorio/fluxor/pkg/web
          - github.com/fluxorio/fluxor/pkg/web/health
          - github.com/fluxorio/fluxor/pkg/web/middleware
          - github.com/fluxorio/fluxor/pkg/web/middleware/auth
          - github.com/fluxorio/fluxor/pkg/web/middleware/security
          - github.com/fluxorio/fluxor/pkg/mesh
          - github.com/fluxorio/fluxor/pkg/tcp
          - github.com/fluxorio/fluxor/pkg/observability/prometheus
          - github.com/fluxorio/fluxor/pkg/observability/otel
          - github.com/fluxorio/fluxor/pkg/appendlog
          - github.com/fluxorio/fluxor/pkg/workflow
          - github.com/fluxorio/fluxor/pkg/lite/core
          - github.com/fluxorio/fluxor/pkg/lite/fluxor
          - github.com/fluxorio/fluxor/pkg/lite/fx
          - github.com/fluxorio/fluxor/pkg/lite/web
          - github.com/fluxorio/fluxor/pkg/lite/webfast
          - github.com/fluxorio/fluxor/pkg/wasm
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-1.24-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-1.24-

    - name: Download dependencies
      run: go mod download

    - name: Verify module
      run: go mod tidy

    - name: Run go vet
      run: go vet ${{ matrix.package }}

    - name: Run tests
      run: |
        echo "Testing package: ${{ matrix.package }}"
        go test -v -race -timeout 5m ${{ matrix.package }}

    - name: Build package
      run: go build ${{ matrix.package }}

  # Lint job (runs in parallel with tests)
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-1.24-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-1.24-

    - name: Download dependencies
      run: go mod download

    - name: Run go vet
      run: go vet ./...

    - name: Check go fmt
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "❌ The following files are not formatted:"
          gofmt -s -l .
          exit 1
        fi
        echo "✅ All files are formatted"

  # Legacy test job (for compatibility, can be removed later)
  test:
    name: Test (Legacy - All Packages)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: false # Disabled - use test-matrix instead
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum

    - name: Download dependencies
      run: go mod download

    - name: Run tests
      run: go test -v -race ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test-matrix
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Build main
      run: go build -v -o bin/fluxor ./cmd/main.go

    - name: Build example
      run: go build -v -o bin/fluxor-example ./cmd/example/main.go

    - name: Build enterprise
      run: go build -v -o bin/fluxor-enterprise ./cmd/enterprise/main.go

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: bin/
        retention-days: 7

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: test-matrix
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Run benchmarks
      run: go test -bench=. -benchmem -run=^$ ./... | tee benchmark.txt

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmarks
        path: benchmark.txt
        retention-days: 30

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        # Scan only the root module code. This repo also contains nested Go
        # modules under examples/fluxor-project/* which gosec cannot analyze correctly
        # from the repository root context.
        args: '-no-fail -fmt sarif -out results.sarif ./cmd/... ./pkg/...'

    - name: Check SARIF file exists
      run: |
        if [ ! -f results.sarif ]; then
          echo "Warning: results.sarif not found, skipping upload"
          exit 0
        fi
        echo "SARIF file exists, proceeding with upload"

    - name: Upload SARIF file
      if: always()
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: results.sarif
        wait-for-processing: false
      continue-on-error: true

  test-examples:
    name: Test Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.24']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v4
      id: cache-examples
      continue-on-error: true
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ matrix.go-version }}-
    
    - name: Clean cache directories
      if: steps.cache-examples.outputs.cache-hit != 'true'
      run: |
        # Clean cache directories if cache restore failed
        rm -rf ~/.cache/go-build || true
        rm -rf ~/go/pkg/mod || true
        # Ensure directories exist with proper permissions
        mkdir -p ~/.cache/go-build
        mkdir -p ~/go/pkg/mod

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Test load-balancing example
      working-directory: examples/load-balancing
      run: |
        go build -o /tmp/load-balancing main.go
        if [ $? -eq 0 ]; then
          echo "✓ load-balancing example builds successfully"
        else
          echo "✗ load-balancing example build failed"
          exit 1
        fi

    - name: Test all-in-one example
      working-directory: examples/fluxor-project/all-in-one
      run: |
        go build -o /tmp/all-in-one main.go
        if [ $? -eq 0 ]; then
          echo "✓ all-in-one example builds successfully"
        else
          echo "✗ all-in-one example build failed"
          exit 1
        fi

    - name: Test api-gateway example
      working-directory: examples/fluxor-project/api-gateway
      run: |
        go build -o /tmp/api-gateway ./verticles/*.go 2>&1 || go build -o /tmp/api-gateway .
        if [ $? -eq 0 ]; then
          echo "✓ api-gateway example builds successfully"
        else
          echo "✗ api-gateway example build failed"
          exit 1
        fi

    - name: Test payment-service example
      working-directory: examples/fluxor-project/payment-service
      run: |
        go build -o /tmp/payment-service ./verticles/*.go 2>&1 || go build -o /tmp/payment-service .
        if [ $? -eq 0 ]; then
          echo "✓ payment-service example builds successfully"
        else
          echo "✗ payment-service example build failed"
          exit 1
        fi

    - name: Test todo-api example
      working-directory: examples/todo-api
      run: |
        if [ -f "main.go" ]; then
          go build -o /tmp/todo-api main.go
          if [ $? -eq 0 ]; then
            echo "✓ todo-api example builds successfully"
          else
            echo "✗ todo-api example build failed"
            exit 1
          fi
        else
          echo "⚠ todo-api example not found, skipping"
        fi

    - name: Test workflow-demo example
      working-directory: examples/workflow-demo
      run: |
        if [ -f "main.go" ]; then
          go build -o /tmp/workflow-demo main.go
          if [ $? -eq 0 ]; then
            echo "✓ workflow-demo example builds successfully"
          else
            echo "✗ workflow-demo example build failed"
            exit 1
          fi
        else
          echo "⚠ workflow-demo example not found, skipping"
        fi

    - name: Run go vet on examples
      run: |
        echo "Running go vet on examples..."
        find examples -name "*.go" -type f -exec dirname {} \; | sort -u | while read dir; do
          if [ -f "$dir/go.mod" ] || [ -f "$dir/main.go" ]; then
            echo "Checking $dir..."
            (cd "$dir" && go vet ./... 2>&1 || true)
          fi
        done

    - name: Summary
      run: |
        echo "## Examples Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ All examples tested with Go ${{ matrix.go-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Examples verified: load-balancing, all-in-one, api-gateway, payment-service" >> $GITHUB_STEP_SUMMARY

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test-matrix, build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (enterprise)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./cmd/enterprise/Dockerfile
        push: false
        load: true
        tags: fluxor-enterprise:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image (enterprise)
      run: |
        docker run --rm fluxor-enterprise:latest --version || true
        docker images | grep fluxor-enterprise

    - name: Build Docker image (load-balancing)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./examples/load-balancing/Dockerfile
        push: false
        load: true
        tags: fluxor-load-balancing:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image (load-balancing)
      run: |
        echo "Verifying load-balancing Docker image..."
        docker images | grep fluxor-load-balancing
        echo "✓ load-balancing Docker image built successfully"
