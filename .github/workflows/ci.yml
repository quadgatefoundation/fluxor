name: CI

on:
  push:
    branches: [ main, develop, 'cursor/**' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        go-version: ['1.24']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v4
      id: cache
      continue-on-error: true
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ matrix.go-version }}-
    
    - name: Clean cache on error
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        rm -rf ~/.cache/go-build || true
        rm -rf ~/go/pkg/mod || true

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run go vet
      run: go vet ./...

    - name: Run go fmt
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "The following files are not formatted:"
          gofmt -s -l .
          exit 1
        fi

    - name: Run tests
      timeout-minutes: 15
      run: |
        # Run tests with timeout and better error handling
        echo "Starting tests with race detector..."
        echo "Test timeout: 8 minutes (Go) + 2 minutes buffer (shell timeout)"
        echo "Step timeout: 15 minutes"
        
        # Exclude loadtest, workflow-demo, todo-api, and load-balancing directories from tests
        # Use timeout command to ensure tests are killed even if Go timeout fails
        # This prevents hanging tests from blocking CI
        timeout 10m bash -c '
          PACKAGES=$(go list ./... | grep -v "/loadtest" | grep -v "/workflow-demo" | grep -v "/todo-api" | grep -v "/load-balancing" | tr "\n" " ")
          echo "Testing packages (excluding loadtest, workflow-demo, todo-api, and load-balancing):"
          echo "$PACKAGES"
          go test -v -race -coverprofile=coverage.out -covermode=atomic -timeout 8m $PACKAGES 2>&1 | tee test-output.log
        ' || {
          EXIT_CODE=$?
          echo "=========================================="
          echo "Tests failed or timed out. Exit code: $EXIT_CODE"
          echo "=========================================="
          echo ""
          echo "Last 100 lines of test output:"
          tail -n 100 test-output.log 2>/dev/null || echo "No test output log found"
          echo ""
          echo "Test files in repository:"
          find . -name "*_test.go" -type f | head -20
          echo ""
          echo "Checking for hanging processes..."
          ps aux | grep -E "(go|test)" | head -10 || true
          echo ""
          echo "Killing any remaining test processes..."
          pkill -9 -f "go test" || true
          pkill -9 -f "go-build" || true
          exit 1
        }
        
        echo "All tests completed successfully"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-${{ matrix.go-version }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Build main
      run: go build -v -o bin/fluxor ./cmd/main.go

    - name: Build example
      run: go build -v -o bin/fluxor-example ./cmd/example/main.go

    - name: Build enterprise
      run: go build -v -o bin/fluxor-enterprise ./cmd/enterprise/main.go

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: bin/
        retention-days: 7

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Run benchmarks
      run: go test -bench=. -benchmem -run=^$ ./... | tee benchmark.txt

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmarks
        path: benchmark.txt
        retention-days: 30

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        # Scan only the root module code. This repo also contains nested Go
        # modules under examples/fluxor-project/* which gosec cannot analyze correctly
        # from the repository root context.
        args: '-no-fail -fmt sarif -out results.sarif ./cmd/... ./pkg/...'

    - name: Check SARIF file exists
      run: |
        if [ ! -f results.sarif ]; then
          echo "Warning: results.sarif not found, skipping upload"
          exit 0
        fi
        echo "SARIF file exists, proceeding with upload"

    - name: Upload SARIF file
      if: always()
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: results.sarif
        wait-for-processing: false
      continue-on-error: true

  test-examples:
    name: Test Examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.24']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v4
      id: cache-examples
      continue-on-error: true
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ matrix.go-version }}-
    
    - name: Clean cache on error
      if: steps.cache-examples.outputs.cache-hit != 'true'
      run: |
        rm -rf ~/.cache/go-build || true
        rm -rf ~/go/pkg/mod || true

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Test all-in-one example
      working-directory: examples/fluxor-project/all-in-one
      run: |
        go build -o /tmp/all-in-one main.go
        if [ $? -eq 0 ]; then
          echo "✓ all-in-one example builds successfully"
        else
          echo "✗ all-in-one example build failed"
          exit 1
        fi

    - name: Test api-gateway example
      working-directory: examples/fluxor-project/api-gateway
      run: |
        go build -o /tmp/api-gateway ./verticles/*.go 2>&1 || go build -o /tmp/api-gateway .
        if [ $? -eq 0 ]; then
          echo "✓ api-gateway example builds successfully"
        else
          echo "✗ api-gateway example build failed"
          exit 1
        fi

    - name: Test payment-service example
      working-directory: examples/fluxor-project/payment-service
      run: |
        go build -o /tmp/payment-service ./verticles/*.go 2>&1 || go build -o /tmp/payment-service .
        if [ $? -eq 0 ]; then
          echo "✓ payment-service example builds successfully"
        else
          echo "✗ payment-service example build failed"
          exit 1
        fi

    - name: Test todo-api example
      working-directory: examples/todo-api
      run: |
        if [ -f "main.go" ]; then
          go build -o /tmp/todo-api main.go
          if [ $? -eq 0 ]; then
            echo "✓ todo-api example builds successfully"
          else
            echo "✗ todo-api example build failed"
            exit 1
          fi
        else
          echo "⚠ todo-api example not found, skipping"
        fi

    - name: Test workflow-demo example
      working-directory: examples/workflow-demo
      run: |
        if [ -f "main.go" ]; then
          go build -o /tmp/workflow-demo main.go
          if [ $? -eq 0 ]; then
            echo "✓ workflow-demo example builds successfully"
          else
            echo "✗ workflow-demo example build failed"
            exit 1
          fi
        else
          echo "⚠ workflow-demo example not found, skipping"
        fi

    - name: Run go vet on examples
      run: |
        echo "Running go vet on examples..."
        find examples -name "*.go" -type f -exec dirname {} \; | sort -u | while read dir; do
          # Skip load-balancing directory
          if [[ "$dir" == *"/load-balancing"* ]]; then
            continue
          fi
          if [ -f "$dir/go.mod" ] || [ -f "$dir/main.go" ]; then
            echo "Checking $dir..."
            (cd "$dir" && go vet ./... 2>&1 || true)
          fi
        done

    - name: Summary
      run: |
        echo "## Examples Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ All examples tested with Go ${{ matrix.go-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Examples verified: all-in-one, api-gateway, payment-service" >> $GITHUB_STEP_SUMMARY

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test, build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (enterprise)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./cmd/enterprise/Dockerfile
        push: false
        tags: fluxor-enterprise:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker run --rm fluxor-enterprise:latest --version || true
        docker images | grep fluxor-enterprise
